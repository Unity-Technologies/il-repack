name: Build, Test, and Release

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
  build-and-test:
    name: Build and Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          3.1.x
          6.0.x
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
      with:
        nuget-version: '6.x'
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ${{ env.NUGET_PACKAGES }}
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.config', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore NuGet packages
      run: nuget restore ILRepack.sln
    
    - name: Build solution
      run: msbuild ILRepack.sln /p:Configuration=Release /p:Platform="Any CPU" /m /v:m
    
    - name: Run unit tests
      run: |
        dotnet test ILRepack.Tests/ILRepack.Tests.csproj --configuration Release --no-build --logger "trx;LogFileName=test-results-unit.trx"
      continue-on-error: false
    
    - name: Run integration tests
      run: |
        dotnet test ILRepack.IntegrationTests/ILRepack.IntegrationTests.csproj --configuration Release --no-build --logger "trx;LogFileName=test-results-integration.trx"
      continue-on-error: false
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          **/TestResults/*.trx
    
    - name: Repack ILRepack.exe
      run: |
        $outputPath = "ILRepack\bin\Release\net461"
        $repackExe = Join-Path $outputPath "ILRepack.exe"
        $tempDir = New-Item -ItemType Directory -Path "temp-repack" -Force
        $repacked = Join-Path $tempDir "ILRepack.exe"
        
        $files = @(
          "ILRepack.exe",
          "Fasterflect.dll",
          "BamlParser.dll",
          "Mono.Cecil.dll",
          "Mono.Cecil.Mdb.dll",
          "Mono.Cecil.Pdb.dll",
          "Mono.Posix.dll"
        )
        
        & $repackExe /log /wildcards /internalize /ndebug /out:$repacked $files
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Repack failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
      working-directory: ILRepack/bin/Release/net461
      shell: pwsh
    
    - name: Repack ILRepack.dll (library)
      run: |
        $outputPath = "ILRepack\bin\Release\net461"
        $repackExe = Join-Path $outputPath "ILRepack.exe"
        $tempDir = "temp-repack"
        $repackedLib = Join-Path $tempDir "ILRepack.dll"
        $keyFile = Join-Path $PWD "ILRepack\ILRepack.snk"
        
        $files = @(
          "ILRepack.exe",
          "Fasterflect.dll",
          "BamlParser.dll",
          "Mono.Cecil.dll",
          "Mono.Cecil.Mdb.dll",
          "Mono.Cecil.Pdb.dll",
          "Mono.Posix.dll"
        )
        
        & $repackExe /log /wildcards /internalize /keyfile:$keyFile /out:$repackedLib /target:library $files
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Repack library failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
      working-directory: ILRepack/bin/Release/net461
      shell: pwsh
    
    - name: Upload repacked binaries
      uses: actions/upload-artifact@v4
      with:
        name: repacked-binaries
        path: |
          ILRepack/bin/Release/net461/temp-repack/ILRepack.exe
          ILRepack/bin/Release/net461/temp-repack/ILRepack.dll
          ILRepack/bin/Release/net461/temp-repack/ILRepack.pdb
  
  create-packages:
    name: Create NuGet Packages
    runs-on: windows-latest
    needs: build-and-test
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download repacked binaries
      uses: actions/download-artifact@v4
      with:
        name: repacked-binaries
        path: artifacts
    
    - name: Determine version
      id: version
      run: |
        if ("${{ github.ref }}" -like "refs/tags/v*") {
          $version = "${{ github.ref }}".Substring(11)
        } else {
          $gitHash = git rev-parse --short HEAD
          $baseVersion = "2.1.8"
          $version = "$baseVersion-dev-$gitHash"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: pwsh
    
    - name: Create NuGet package (tools)
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        $nuspecContent = @"
<?xml version="1.0" encoding="utf-8"?>
<package xmlns="http://schemas.microsoft.com/packaging/2010/07/nuspec.xsd">
  <metadata>
    <id>avostres.ILRepack</id>
    <version>$version</version>
    <title>ILRepack - Open-source alternative to ILMerge</title>
    <authors>Alexander Vostres, Francois Valdy</authors>
    <owners>Alexander Vostres</owners>
    <projectUrl>https://github.com/Alexx999/il-repack</projectUrl>
    <requireLicenseAcceptance>false</requireLicenseAcceptance>
    <description>ILRepack is meant at replacing ILMerge / Mono.Merge.
The former being closed-source, impossible to customize, slow, resource consuming and many more. The later being deprecated, unsupported, and based on an old version of Mono.Cecil.</description>
    <summary>ILRepack is a utility that can be used to merge multiple .NET assemblies into a single assembly</summary>
    <copyright>Copyright Alexander Vostres 2018-2020, Francois Valdy 2011-2015</copyright>
  </metadata>
  <files>
    <file src="artifacts\ILRepack.exe" target="tools" />
    <file src="artifacts\ILRepack.pdb" target="tools" />
    <file src="ILRepack.props" target="build" />
  </files>
</package>
"@
        
        $nuspecPath = "avostres.ILRepack.nuspec"
        $nuspecContent | Out-File -FilePath $nuspecPath -Encoding UTF8
        
        nuget pack $nuspecPath -OutputDirectory packages
      shell: pwsh
    
    - name: Create NuGet package (library)
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        $nuspecContent = @"
<?xml version="1.0" encoding="utf-8"?>
<package xmlns="http://schemas.microsoft.com/packaging/2010/07/nuspec.xsd">
  <metadata>
    <id>avostres.ILRepack.Lib</id>
    <version>$version</version>
    <title>ILRepack - Open-source alternative to ILMerge</title>
    <authors>Alexander Vostres, Francois Valdy</authors>
    <owners>Alexander Vostres</owners>
    <projectUrl>https://github.com/Alexx999/il-repack</projectUrl>
    <requireLicenseAcceptance>false</requireLicenseAcceptance>
    <description>ILRepack is meant at replacing ILMerge / Mono.Merge.
The former being closed-source, impossible to customize, slow, resource consuming and many more. The later being deprecated, unsupported, and based on an old version of Mono.Cecil.

This package provides a library, for use within tools/build projects.
If you need the tool as an executable, this is not the package you're looking for, this one is: http://www.nuget.org/packages/ILRepack/.</description>
    <summary>ILRepack is a utility that can be used to merge multiple .NET assemblies into a single assembly (Packaged as library)</summary>
    <copyright>Copyright Alexander Vostres 2018-2020, Francois Valdy 2011-2015</copyright>
  </metadata>
  <files>
    <file src="artifacts\ILRepack.dll" target="lib/net40" />
  </files>
</package>
"@
        
        $nuspecPath = "avostres.ILRepack.Lib.nuspec"
        $nuspecContent | Out-File -FilePath $nuspecPath -Encoding UTF8
        
        nuget pack $nuspecPath -OutputDirectory packages
      shell: pwsh
    
    - name: Upload NuGet packages
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: packages/*.nupkg
    
    - name: Publish to NuGet
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        Get-ChildItem packages/*.nupkg | ForEach-Object {
          nuget push $_.FullName -Source https://api.nuget.org/v3/index.json -ApiKey ${{ secrets.NUGET_API_KEY }} -SkipDuplicate
        }
      shell: pwsh
  
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: create-packages
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: packages
    
    - name: Download repacked binaries
      uses: actions/download-artifact@v4
      with:
        name: repacked-binaries
        path: binaries
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          packages/*.nupkg
          binaries/ILRepack.exe
          binaries/ILRepack.dll
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

